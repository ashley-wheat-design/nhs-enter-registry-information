{% extends 'layout.html' %}
{% set p = data.selectedPatient %}
{% set pageName = "Registry information" %}
{% set showPatientInfo = true %}
{% set currentSection = "record-procedure" %}

{{ p.name }}

{% block beforeContent %}

{% endblock %}

{% block content %}

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <form class="form" action="confirmation" method="post">
      <div class="nhsuk-form-group">
        <fieldset class="nhsuk-fieldset">
          <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--l">
            <h1 class="nhsuk-fieldset__heading-l">
              {{ p.firstName }} {{ p.lastName }}'s procedures and devices
            </h1>
          </legend>
          <a href="/record-procedure/" class="nhsuk-button">
            Record a procedure
          </a>

          <div class="nhsuk-tabs nhsuk-u-margin-top-4" data-module="nhsuk-tabs">
            <h2 class="nhsuk-tabs__title">
              Contents
            </h2>
            <ul class="nhsuk-tabs__list">
              <li class="nhsuk-tabs__list-item nhsuk-tabs__list-item--selected">
                <a class="nhsuk-tabs__tab" href="#procedures">
                  Procedures ({{ p.procedures.length }})
                </a>
              </li>
              <li class="nhsuk-tabs__list-item">
                <a class="nhsuk-tabs__tab" href="#devices">
                  Devices ({{ (p.devices or []).length }})
                </a>
              </li>
            </ul>
            <div class="nhsuk-tabs__panel" id="procedures">
              <table class="nhsuk-table">
                <caption class="nhsuk-table__caption">
                  Procedures
                </caption>
                <thead class="nhsuk-table__head">
                  <tr class="nhsuk-table__row">
                    <th scope="col" class="nhsuk-table__header">
                      Date
                    </th>
                    <th scope="col" class="nhsuk-table__header nhsuk-table__header">
                      Primary diagnosis
                    </th>
                    <th scope="col" class="nhsuk-table__header nhsuk-table__header">
                      Outcome
                    </th>
                    <th scope="col" class="nhsuk-table__header nhsuk-table__header">
                      Responsible consultant
                    </th>
                  </tr>
                </thead>
                <tbody class="nhsuk-table__body">
  {% for proc in p.procedures %}
    <tr class="nhsuk-table__row">
      <th scope="row" class="nhsuk-table__header">
        <a class="nhsuk-link--no-visited-state" href="/patient-profile/procedures/{{ proc.id }}">
          {{ formatDate(proc.date) }}
        </a>
      </th>

      <td class="nhsuk-table__cell">
        {{ proc.primaryDiagnosisCode }} - {{ getIcd10Label(proc.primaryDiagnosisCode) or 'Unknown diagnosis' }}
      </td>

      <td class="nhsuk-table__cell">
        {{ proc.operationOutcome | capitalize }}
      </td>

      <td class="nhsuk-table__cell">
        {% set c = proc.clinicians.responsibleConsultant %}
        {% if c %}
          {{ c.firstName }} {{ c.lastName }}
        {% else %}
          <span class="nhsuk-hint-text">Not recorded</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</tbody>

            </table>
          </div>
          <div class="nhsuk-tabs__panel nhsuk-tabs__panel--hidden" id="devices">
            <table class="nhsuk-table">
              <caption class="nhsuk-table__caption">
                Devices
              </caption>
              <thead class="nhsuk-table__head">
                <tr class="nhsuk-table__row">
                  <th scope="col" class="nhsuk-table__header">
                    Description
                  </th>
                  <th scope="col" class="nhsuk-table__header nhsuk-table__header">
                    Manufacturer
                  </th>
                  <th scope="col" class="nhsuk-table__header nhsuk-table__header" width="20%">
                    Procedure date
                  </th>
                  <th scope="col" class="nhsuk-table__header nhsuk-table__header">
                    Status
                  </th>
                </tr>
              </thead>
              <tbody class="nhsuk-table__body">
                {% if p.devices and p.devices.length %}
                {% for device in p.devices %}
                <tr class="nhsuk-table__row">
                  <td class="nhsuk-table__cell">
                    <a class="nhsuk-link--no-visited-state"
   href="/patient-profile/devices/{{ (device.uniqueDeviceIdentifier or device.selectedDeviceCode) | urlencode }}">
  {{ device.productDescription or device.medicalDeviceBrandOrModelName }}
</a>

                  </td>
                  <td class="nhsuk-table__cell nhsuk-table__cell">
                    {{ device.deviceManufacturer }}
                  </td>
                  <td class="nhsuk-table__cell nhsuk-table__cell">
                    <a class="nhsuk-link--no-visited-state" href="/patient-profile/procedures/{{ device.procedureId }}">
  {{ formatDate(device.procedureDate) }}
</a>

                  </td>
                  <td class="nhsuk-table__cell nhsuk-table__cell">
                    {% if device.status == "Implanted" %}
                    <strong class="nhsuk-tag nhsuk-tag--blue">
                      {{ device.status }}
                    </strong>
                    {% elif device.status == "Removed" %}
                    <strong class="nhsuk-tag nhsuk-tag--grey">
                      {{ device.status }}
                    </strong>
                    {% else %}
                    <div class="nhsuk-hint">Not recorded</div>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
      </div>






      </fieldset>
  </div>
  </form>
</div>
</div>
{% endblock %}
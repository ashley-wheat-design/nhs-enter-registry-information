{% extends '../layout.html' %}
{% set pageName = "Check patient details" %}

{% set p = data.selectedPatient or {} %}
{% set procedures = p.procedures or [] %}
{% set latest = procedures[procedures.length - 1] %}

{% set op = data.currentOperation or {} %}
{% set diagnosisCodes = data.diagnosisCodes or [] %}
{% set primaryCode = diagnosisCodes[0] %}
{% set additionalCodes = diagnosisCodes.slice(1) %}
{% set asa = op.asaClassification %}
{% set opOutcome = op.operationOutcome %}
{% set lat = op.laterality %}
{% set procDate = data.procedureDate %}
{% set procTime = data.procedureTime %}

{% set devicesAdded = data.currentOperationDevices or [] %}
{% set responsible = data.responsibleConsultant %}
{% set supervising = data.supervisingSurgeon %}
{% set leadSurgeons = data.leadSurgeons or [] %}

{% if latest %}
  {% if not procDate %}{% set procDate = latest.date %}{% endif %}
  {% if not procTime %}{% set procTime = latest.time %}{% endif %}

  {% if not primaryCode %}{% set primaryCode = latest.primaryDiagnosisCode %}{% endif %}
  {% if additionalCodes.length == 0 %}{% set additionalCodes = latest.additionalDiagnosisCodes or [] %}{% endif %}

  {% if not asa %}{% set asa = latest.asaClassification %}{% endif %}
  {% if not opOutcome %}{% set opOutcome = latest.operationOutcome %}{% endif %}
  {% if not lat %}{% set lat = latest.laterality %}{% endif %}

  {% if devicesAdded.length == 0 %}{% set devicesAdded = latest.devices or [] %}{% endif %}

  {% if not responsible and latest.clinicians %}{% set responsible = latest.clinicians.responsibleConsultant %}{% endif %}
  {% if not supervising and latest.clinicians %}{% set supervising = latest.clinicians.supervisingSurgeon %}{% endif %}
  {% if leadSurgeons.length == 0 and latest.clinicians %}{% set leadSurgeons = latest.clinicians.leadSurgeons or [] %}{% endif %}
{% endif %}

{% block beforeContent %}
<a class="nhsuk-back-link" href="#">
  Back
</a>
{% endblock %}

{% block content %}

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-two-thirds">
    <form class="form" action="/record-procedure/confirmation" method="post">
      <div class="nhsuk-form-group">
        <fieldset class="nhsuk-fieldset">
          <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--l">
            <h1 class="nhsuk-fieldset__heading">
              Check your answers before submitting
            </h1>
          </legend>

          <div class="nhsuk-card nhsuk-u-margin-top-6">
            <div class="nhsuk-card__content">
              <h3 class="nhsuk-card__heading">Patient details</h3>

              <dl class="nhsuk-summary-list">
                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Name</dt>
                  <dd class="nhsuk-summary-list__value">{{ p.firstName }} {{ p.lastName }}</dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Date of birth</dt>
                  <dd class="nhsuk-summary-list__value">{{ p.dob }}</dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Address</dt>
                  <dd class="nhsuk-summary-list__value">
                    {{ (p.address or []) | join('<br>') | safe }}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Email address</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if p.emailAddress %}{{ p.emailAddress }}{% else %}Not entered{% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Gender</dt>
                  <dd class="nhsuk-summary-list__value">{{ p.gender }}</dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">NHS number</dt>
                  <dd class="nhsuk-summary-list__value">{{ p.nhsNumber }}</dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Registered GP</dt>
                  <dd class="nhsuk-summary-list__value">
                    {{ (p.registeredGp or []) | join('<br>') | safe }}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Height</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if p.heightCm %}{{ p.heightCm }} cm{% else %}Not entered{% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Weight</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if p.weightKg %}{{ p.weightKg }} kg{% else %}Not entered{% endif %}
                  </dd>
                </div>
              </dl>
            </div>
          </div>

          <div class="nhsuk-card">
            <div class="nhsuk-card__content">
              <h3 class="nhsuk-card__heading">Operation details</h3>

              <dl class="nhsuk-summary-list">
                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Procedure date</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if procDate %}{{ procDate }}{% else %}—{% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Procedure time</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if procTime %}{{ procTime }}{% else %}—{% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Primary diagnosis</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if primaryCode %}
                      {{ primaryCode }}{% if icd10[primaryCode] %} - {{ icd10[primaryCode] }}{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>

                {% if additionalCodes.length %}
                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Additional diagnoses</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% for code in additionalCodes %}
                    <div class="nhsuk-u-margin-bottom-2">
                      {{ code }}{% if icd10[code] %} - {{ icd10[code] }}{% endif %}
                    </div>
                    {% endfor %}
                  </dd>
                </div>
                {% endif %}

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">ASA physical status</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if asa %}
                      {{ asa }}{% if asaPhysicalStatus[asa] %} - {{ asaPhysicalStatus[asa] }}{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Operation outcome</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if opOutcome == 'implant' %}
                      Implant
                    {% elif opOutcome == 'device-removal' %}
                      Removal of device
                    {% elif opOutcome == 'replacement' %}
                      Replacement (removal and implant)
                    {% elif opOutcome == 'other' %}
                      Other
                      {% if op.operationOutcomeOtherDetail %}
                        <br><span class="nhsuk-hint">{{ op.operationOutcomeOtherDetail }}</span>
                      {% elif latest and latest.operationOutcomeOtherDetail %}
                        <br><span class="nhsuk-hint">{{ latest.operationOutcomeOtherDetail }}</span>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">Anatomical side</dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if lat == 'L' %}Left
                    {% elif lat == 'R' %}Right
                    {% elif lat == 'B' %}Bilateral
                    {% elif lat == 'M' %}Midline
                    {% elif lat == '8' %}Not applicable
                    {% elif lat == '9' %}Not known
                    {% else %}—
                    {% endif %}
                  </dd>
                </div>
              </dl>
            </div>
          </div>

          <div class="nhsuk-card">
            <div class="nhsuk-card__content">
              <h3 class="nhsuk-card__heading">
                Devices ({{ devicesAdded.length }})
              </h3>

              {% if devicesAdded.length %}
                {% for d in devicesAdded %}
                <div class="nhsuk-card nhsuk-u-margin-bottom-4">
                  <div class="nhsuk-card__content">
                    <h3 class="nhsuk-card__heading nhsuk-heading-xs">{{ d.medicalDeviceBrandOrModelName }}</h3>

                    <p class="nhsuk-card__description nhsuk-u-margin-bottom-3 nhsuk-body-s">
                      {{ d.productDescription }}
                    </p>

                    <dl class="nhsuk-summary-list nhsuk-summary-list--no-border">
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">Manufacturer</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.deviceManufacturer }}</dd>
                      </div>
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">Reference</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.medicalDeviceReferenceNumber }}</dd>
                      </div>
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">Serial</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.medicalDeviceSerialNumber }}</dd>
                      </div>
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">Lot</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.medicalDeviceLotNumber }}</dd>
                      </div>
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">Expiry</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.medicalDeviceExpiryDate }}</dd>
                      </div>
                      <div class="nhsuk-summary-list__row nhsuk-body-s">
                        <dt class="nhsuk-summary-list__key">UDI</dt>
                        <dd class="nhsuk-summary-list__value">{{ d.uniqueDeviceIdentifier }}</dd>
                      </div>
                    </dl>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <p class="nhsuk-body">—</p>
              {% endif %}
            </div>
          </div>

          <div class="nhsuk-card">
            <div class="nhsuk-card__content">
              <h3 class="nhsuk-card__heading">
                Clinician details
              </h3>

              <dl class="nhsuk-summary-list nhsuk-summary-list--no-border">

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">
                    Operation responsible consultant
                  </dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if responsible %}
                      {{ responsible.title }} {{ responsible.firstName }} {{ responsible.lastName }}<br>
                      <span class="nhsuk-hint">GMC number: {{ responsible.gmc or responsible.gmcNumber or responsible.registrationNumber }}</span>
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                  <!-- <dd class="nhsuk-summary-list__actions">
                    <a class="nhsuk-link" href="/record-procedure/clinician/clinicians-summary">Change<span class="nhsuk-u-visually-hidden"> operation responsible consultant</span></a>
                  </dd> -->
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">
                    Operation supervising surgeon
                  </dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if supervising %}
                      {{ supervising.title }} {{ supervising.firstName }} {{ supervising.lastName }}<br>
                      <span class="nhsuk-hint">GMC number: {{ supervising.gmc or supervising.gmcNumber or supervising.registrationNumber }}</span>
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                  <!-- <dd class="nhsuk-summary-list__actions">
                    <a class="nhsuk-link" href="/record-procedure/clinician/clinicians-summary">Change<span class="nhsuk-u-visually-hidden"> operation supervising surgeon</span></a>
                  </dd> -->
                </div>

                <div class="nhsuk-summary-list__row">
                  <dt class="nhsuk-summary-list__key">
                    Operation lead surgeon{% if leadSurgeons.length != 1 %}s{% endif %}
                  </dt>
                  <dd class="nhsuk-summary-list__value">
                    {% if leadSurgeons.length %}
                      <ul class="nhsuk-list nhsuk-u-margin-bottom-0">
                        {% for c in leadSurgeons %}
                          <li>
                            {{ c.title }} {{ c.firstName }} {{ c.lastName }}<br>
                            <span class="nhsuk-hint">GMC number: {{ c.gmc or c.gmcNumber or c.registrationNumber }}</span>
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                  <!-- <dd class="nhsuk-summary-list__actions">
                    <a class="nhsuk-link" href="/record-procedure/clinician/clinicians-summary">Change<span class="nhsuk-u-visually-hidden"> operation lead surgeons</span></a>
                  </dd> -->
                </div>

              </dl>
            </div>
          </div>

        </fieldset>
      </div>

      <button class="nhsuk-button" data-module="nhsuk-button" type="submit">
        Confirm and submit
      </button>
    </form>
  </div>
</div>

{% endblock %}
